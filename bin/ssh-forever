#!/usr/bin/env ruby

$:.unshift File.join(File.dirname(__FILE__), '..', 'lib')
require 'ssh-forever'
require 'optparse'

banner = %{Usage: ssh-forever username@yourserver.com [options]

More info:
  https://github.com/mattwynne/ssh-forever
}

options = {}
OptionParser.new do |opts|
  opts.banner = banner

  opts.on('-b', '--batch', "Run without interactive login", "Implies auto, intense, quiet and not login nor debug.") do |boolean|
    options[:batch] = true
    options[:auto] = true
    options[:login] = false
    options[:intense] = true
    options[:quiet] = true
    options[:debug] = false
  end

  opts.on('-a', '--auto', "Run without prompting.") do |boolean|
    options[:auto] = true
  end

  opts.on('-c', '--config_file [FILE]', String, "SSH client config file path.") do |config_file|
    options[:config_file] = config_file
  end

  opts.on('-d', '--debug', "Run SSH verbosely.") do |boolean|
    # do not debug in batch mode
    options[:debug] = true unless options[:batch]
  end

  opts.on('-l', '--login', "Open SSH connection and stay logged in (default).") do |boolean|
    options[:login] = true unless options[:batch]
  end

  opts.on('-p', '--port [PORT]', Integer, "SSH server port.") do |port|
    options[:port] = port
  end

  opts.on('-i', '--identity_file [FILE]', String, "SSH identity file path (no .pub extension).") do |identity_file|
    options[:identity_file] = identity_file
  end

  opts.on('-j', '--intense', "High SSH intensity.","If no data from the server after 1 second (default 15): Disconnect after 1 (default 3) unanswered 'server-alive' message.") do |boolean|
    options[:intense] = true
  end

  opts.on('-n', '--name [NAME]', String, "SSH host name alias you wish to use.") do |name|
    options[:name] = name
  end

  opts.on('-q', '--quiet', "Run without output.") do |boolean|
    options[:quiet] = true
    options[:debug] = false
  end

  opts.on('-s', '--strict', "SSH with stricthostkeychecking=yes (default:no)") do |boolean|
    options[:strict] = true
  end

end.parse!

login = ARGV[0]

if login.nil?
  puts banner + "  ssh-forever --help\n"
  exit 1
end
if options[:batch]
  SshForever::SecureShellForever.new(login, options).initialization_run
else
  SshForever::SecureShellForever.new(login, options).run_interactive
end
